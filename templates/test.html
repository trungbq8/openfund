<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1, user-scalable=no">
   <title>OpenFund - Sign up</title>
   <link rel="icon" href="/static/app_assets/open_fund_logo.png">
   <link rel="stylesheet" href="/static/css/style.css">
   <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
   <!-- Add Ethereum Web3 library -->
   <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
</head>
<body>
   <style>
      body{
         padding: 20px;
         justify-content: center;
         box-sizing: border-box;
      }
      .sign-up-container{
         width: 100%;
         max-width: 800px;
         border-radius: 20px;
         display: flex;
         box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.15);
      }
      .sign-up-image{
         width: 50%;
         height: 100%;
      }
      .sign-up-image img{
         width: 100%;
         height: 100%;
         object-fit: cover;
         border-top-left-radius: 20px;
         border-bottom-left-radius: 20px;
      }
      .sign-up-content{
         padding: 10px 26px;
         width: 50%;
         box-sizing: border-box;
         font-size: 0.86rem;
      }
      .sign-up-content p a{
         color: black;
      }
      .sign-up-content h1{
         font-size: 1.2rem;
         margin: 10px 0;
         opacity: 0.86;
      }
      .input-group {
         display: flex;
         flex-direction: column;
         margin-bottom: 5px;
      }
      input{
         padding: 5.8px 10px;
         border-radius: 10px;
         border: solid 1px rgb(200, 200, 200);
         font-family: "Poppins";
      }
      label {
         opacity: 0.8;
         font-size: 0.86rem;
      }
      .name-field{
         display: flex;
         align-items: center;
         justify-content: space-between;
      }
      .name-field .input-group{
         width: 49%;
      }
      .wallet-address-field{
         display: flex;
         align-items: end;
         justify-content: space-between;
      }
      .wallet-address-field .input-group{
         width: 65%;
      }
      .connect-raiser-wallet{
         margin-bottom: 5px;
         padding: 5.8px 10px;
         border-radius: 10px;
         border: solid 1px rgb(88, 88, 88);
         width: 33%;
         background-color: white;
         cursor: pointer;
      }
      .connect-raiser-wallet:hover{
         background-color: rgb(188, 200, 204);
      }
      @media (max-width: 960px) {
         .sign-up-container{
            flex-direction: column;
         }
         .sign-up-image{
            width: 100%;
            height: 100px;
         }
         .sign-up-image img{
            border-bottom-left-radius: 0px;
            border-top-right-radius: 20px;
         }
         .sign-up-content{
            width: 100%;
         }
      }
      .agree-policy{
         display: flex;
         font-size: 0.86rem;
         gap: 5px;
      }
      .agree-policy p{
         margin: 5px 0;
      }
      .agree-policy p a{
         color: black;
      }
      .create-account{
         margin-top: 5px;
         padding: 8px 10px;
         border-radius: 15px;
         border: solid 1px black;
         background-color: black;
         color: white;
         cursor: pointer;
      }
      .create-account-container{
         width: 100%;
         display: flex;
         align-items: center;
         justify-content: center;
      }
      .password-wrapper {
         position: relative;
         display: flex;
         align-items: center;
      }

      .password-wrapper input {
         width: 100%;
         padding-right: 35px;
      }

      .toggle-password {
         position: absolute;
         right: 10px;
         cursor: pointer;
         color: gray;
      }
      
      .hidden {
         display: none;
      }
      
      .overlay {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.5);
         z-index: 1000;
         display: flex;
         justify-content: center;
         align-items: center;
      }
      
      .connect-wallet-box {
         background-color: white;
         padding: 20px;
         border-radius: 10px;
         width: 400px;
         max-width: 90%;
         position: relative;
      }
      
      .close-connect-wallet-btn {
         position: absolute;
         top: 10px;
         right: 10px;
         background: none;
         border: none;
         font-size: 20px;
         cursor: pointer;
      }
      
      .wallet_intergrated {
         display: flex;
         align-items: center;
         padding: 10px;
         margin: 10px 0;
         width: 100%;
         border: 1px solid #ddd;
         border-radius: 10px;
         background-color: white;
         cursor: pointer;
      }
      
      .wallet_intergrated:hover {
         background-color: #f5f5f5;
      }
      
      .wallet-icon-logo {
         width: 24px;
         height: 24px;
         margin-right: 10px;
      }
      
      .error-message {
         color: red;
         font-size: 0.8rem;
         margin-top: 2px;
      }
      
      .success-message {
         color: green;
         font-size: 0.9rem;
         text-align: center;
         margin-top: 10px;
      }
      
      /* New wallet verification styles */
      .wallet-status {
         display: flex;
         align-items: center;
         font-size: 0.8rem;
         margin-top: 2px;
      }
      
      .wallet-status.connected {
         color: green;
      }
      
      .wallet-status.not-connected {
         color: #999;
      }
      
      .wallet-status i {
         margin-right: 5px;
      }
      
      .loading {
         display: inline-block;
         width: 12px;
         height: 12px;
         border: 2px solid rgba(0, 0, 0, 0.1);
         border-left-color: #09f;
         border-radius: 50%;
         animation: spin 1s linear infinite;
         margin-right: 5px;
      }
      
      @keyframes spin {
         to { transform: rotate(360deg); }
      }

   </style>
   <!-- connect wallet -->
   <div class="overlay hidden" id="overlay">
      <div class="connect-wallet-box hidden" id="connect-wallet-box">
         <button class="close-connect-wallet-btn" id="close-connect-wallet-btn">
            <i class="fa-solid fa-xmark"></i>
         </button>
         <h1>Connect wallet</h1>
         <hr style="width: 100px;">
         <button class="wallet_intergrated" data-wallet="metamask"><img class="wallet-icon-logo" src="/static/app_assets/metamask.png" alt="Metamask logo">Metamask</button>
         <button class="wallet_intergrated" data-wallet="binance"><img class="wallet-icon-logo" src="/static/app_assets/binance_web3.png" alt="Binance Web3 logo">Binance Web3</button>
         <button class="wallet_intergrated" data-wallet="okx"><img class="wallet-icon-logo" src="/static/app_assets/okx_web3.png" alt="OKX Web3 logo">OKX Web3</button>
         <button class="wallet_intergrated" data-wallet="trust"><img class="wallet-icon-logo" src="/static/app_assets/trust_wallet.png" alt="Trust Wallet logo">Trust Wallet</button>
         <button class="wallet_intergrated" data-wallet="coinbase"><img class="wallet-icon-logo" src="/static/app_assets/coinbase_wallet.png" alt="Coinbase Wallet logo">Coinbase Wallet</button>
         <p>By connecting a wallet, you agree to the OpenFund's <a style="color:black" href="/term-service">Terms of Service</a> and consent to its <a style="color:black" href="/privacy-policy">Privacy Policy</a>.</p>
      </div>
   </div>
   <!-- end connect wallet -->
   <div class="sign-up-container">
      <div class="sign-up-image">
         <img src="/static/app_assets/sign-in-up.png">
      </div>
      <div class="sign-up-content">
         <h1>Create raiser account</h1>
         <form id="signup-form">
            <div class="name-field">
               <div class="input-group">
                  <label for="first_name">First name</label>
                  <input name="first_name" id="first_name" required>
                  <span class="error-message" id="first-name-error"></span>
               </div>
               <div class="input-group">
                  <label for="last_name">Last name</label>
                  <input name="last_name" id="last_name" required>
                  <span class="error-message" id="last-name-error"></span>
               </div>
            </div>

            <div class="input-group">
               <label for="email">Email</label>
               <input name="email" id="email" type="email" required>
               <span class="error-message" id="email-error"></span>
            </div>
            <div class="input-group">
               <label for="password">Password</label>
               <div class="password-wrapper">
                  <input name="password" id="password" type="password" required>
                  <i class="fa-solid fa-eye-slash toggle-password" data-target="password"></i>
               </div>
               <span class="error-message" id="password-error"></span>
            </div>
            <div class="input-group">
               <label for="confirm-password">Confirm password</label>
               <div class="password-wrapper">
                  <input name="confirm-password" id="confirm-password" type="password" required>
                  <i class="fa-solid fa-eye-slash toggle-password" data-target="confirm-password"></i>
               </div>
               <span class="error-message" id="confirm-password-error"></span>
            </div>
            <div class="wallet-address-field">
               <div class="input-group">
                  <label for="wallet-address">Wallet Address</label>
                  <input name="wallet_address" id="wallet-address" readonly required>
                  <div class="wallet-status not-connected" id="wallet-status">
                     <i class="fa-solid fa-circle-xmark"></i> Not connected
                  </div>
                  <span class="error-message" id="wallet-address-error"></span>
                  <input type="hidden" id="signature" name="signature">
                  <input type="hidden" id="signed-message" name="signed-message">
               </div>
               <button type="button" class="connect-raiser-wallet" id="connect-raiser-wallet">Connect</button>
            </div>
            <div class="agree-policy">
               <input type="checkbox" class="agree-policy-check" id="agree-policy" required>
               <p>I agree to the <a href="/privacy-policy">Privacy & Policy</a></p>
            </div>
            <span class="error-message" id="agree-policy-error"></span>
            <div class="success-message" id="success-message"></div>
            <div class="create-account-container">
               <button type="submit" class="create-account" id="submit-btn">Create account</button>
            </div>
         </form>
         <p>Already have account? <a href="/login">Login</a></p>
      </div>
   </div>
   <script>
      // Password visibility toggle
      document.querySelectorAll('.toggle-password').forEach(icon => {
         icon.addEventListener('click', () => {
            const targetId = icon.getAttribute('data-target');
            const input = document.getElementById(targetId);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
   
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
         });
      });

      // Web3 and wallet connection functionality
      let web3;
      let selectedWallet;
      let connectedAccount;
      let signature;
      let signedMessage;
      let nonce;
      
      // DOM elements
      const connect_wallet_btn = document.getElementById("connect-raiser-wallet");
      const close_wallet_btn = document.getElementById("close-connect-wallet-btn");
      const connect_box = document.getElementById("connect-wallet-box");
      const overlay = document.getElementById("overlay");
      const walletAddressInput = document.getElementById("wallet-address");
      const walletStatus = document.getElementById("wallet-status");
      const signatureInput = document.getElementById("signature");
      const signedMessageInput = document.getElementById("signed-message");
      const submitBtn = document.getElementById("submit-btn");
      
      // Function to check if MetaMask is installed
      const isMetaMaskInstalled = () => {
         return Boolean(window.ethereum && window.ethereum.isMetaMask);
      };
      
      // Function to get a nonce from server
      async function getNonce() {
         try {
            const response = await fetch('/api/generate-nonce');
            const data = await response.json();
            return data.nonce;
         } catch (error) {
            console.error('Error getting nonce:', error);
            return null;
         }
      }
      
      // Function to sign a message with MetaMask
      async function signMessage(account, message) {
         try {
            const signedMsg = await window.ethereum.request({
               method: 'personal_sign',
               params: [message, account]
            });
            return signedMsg;
         } catch (error) {
            console.error('Error signing message:', error);
            return null;
         }
      }
      
      // Function to verify signature on the server
      async function verifySignature(address, signature, message) {
         try {
            const response = await fetch('/api/verify-signature', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json'
               },
               body: JSON.stringify({
                  wallet_address: address,
                  signature: signature,
                  message: message
               })
            });
            
            const data = await response.json();
            return data.success;
         } catch (error) {
            console.error('Error verifying signature:', error);
            return false;
         }
      }
      
      // Connect wallet button event listener
      connect_wallet_btn.addEventListener("click", function() {
         connect_box.classList.remove("hidden");
         overlay.classList.remove("hidden");
      });

      // Close wallet modal
      close_wallet_btn.addEventListener("click", function() {
         connect_box.classList.add("hidden");
         overlay.classList.add("hidden");
      });
      
      // Wallet selection and connection logic
      document.querySelectorAll('.wallet_intergrated').forEach(button => {
         button.addEventListener('click', async function() {
            const walletType = this.getAttribute('data-wallet');
            selectedWallet = walletType;
            
            // Currently only MetaMask is fully implemented
            if (walletType === 'metamask') {
               if (!isMetaMaskInstalled()) {
                  alert('Please install MetaMask to continue!');
                  return;
               }
               
               try {
                  // Show loading state
                  walletStatus.innerHTML = '<div class="loading"></div> Connecting...';
                  walletStatus.className = 'wallet-status';
                  
                  // Request accounts from MetaMask
                  const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                  connectedAccount = accounts[0];
                  
                  // Set the wallet address in the input field
                  walletAddressInput.value = connectedAccount;
                  
                  // Update the wallet status indicator
                  walletStatus.className = 'wallet-status connected';
                  walletStatus.innerHTML = '<i class="fa-solid fa-circle-check"></i> Connected';
                  
                  // Get a nonce from the server
                  nonce = await getNonce();
                  
                  // Create message to sign
                  const message = `Sign this message to verify your wallet ownership with OpenFund. Nonce: ${nonce}`;
                  
                  // Request signature from user
                  signature = await signMessage(connectedAccount, message);
                  
                  if (signature) {
                     // Store the signature and message for form submission
                     signatureInput.value = signature;
                     signedMessageInput.value = message;
                     
                     // Verify the signature on the server
                     const isVerified = await verifySignature(connectedAccount, signature, message);
                     
                     if (isVerified) {
                        walletStatus.innerHTML = '<i class="fa-solid fa-circle-check"></i> Verified';
                     } else {
                        walletStatus.className = 'wallet-status not-connected';
                        walletStatus.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Verification failed';
                        walletAddressInput.value = '';
                     }
                  } else {
                     walletStatus.className = 'wallet-status not-connected';
                     walletStatus.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Signature rejected';
                     walletAddressInput.value = '';
                  }
                  
                  // Close the wallet connection modal
                  connect_box.classList.add("hidden");
                  overlay.classList.add("hidden");
                  
               } catch (error) {
                  console.error('Error connecting to MetaMask:', error);
                  walletStatus.className = 'wallet-status not-connected';
                  walletStatus.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Connection failed';
                  walletAddressInput.value = '';
                  
                  // Close the wallet connection modal
                  connect_box.classList.add("hidden");
                  overlay.classList.add("hidden");
               }
            } else {
               // For other wallets (not fully implemented)
               alert(`${walletType} wallet integration coming soon! Currently only MetaMask is supported.`);
               
               // Close the wallet connection modal
               connect_box.classList.add("hidden");
               overlay.classList.add("hidden");
            }
         });
      });
      
      // Listen for account changes
      if (window.ethereum) {
         window.ethereum.on('accountsChanged', function (accounts) {
            // Reset wallet connection status
            walletStatus.className = 'wallet-status not-connected';
            walletStatus.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Not connected';
            walletAddressInput.value = '';
            signatureInput.value = '';
            signedMessageInput.value = '';
            
            // Ask user to reconnect
            alert('Your wallet account has changed. Please reconnect your wallet to continue.');
         });
      }
      
      // Form validation and submission
      const signupForm = document.getElementById('signup-form');
      
      signupForm.addEventListener('submit', async function(e) {
         e.preventDefault();
         
         // Reset error messages
         document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
         
         // Get form values
         const firstName = document.getElementById('first_name').value.trim();
         const lastName = document.getElementById('last_name').value.trim();
         const email = document.getElementById('email').value.trim();
         const password = document.getElementById('password').value;
         const confirmPassword = document.getElementById('confirm-password').value;
         const walletAddress = document.getElementById('wallet-address').value.trim();
         const agreePolicy = document.getElementById('agree-policy').checked;
         const signature = document.getElementById('signature').value;
         const signedMessage = document.getElementById('signed-message').value;
         
         // Validate form
         let isValid = true;
         
         if (!firstName) {
            document.getElementById('first-name-error').textContent = 'First name is required';
            isValid = false;
         }
         
         if (!lastName) {
            document.getElementById('last-name-error').textContent = 'Last name is required';
            isValid = false;
         }
         
         if (!email) {
            document.getElementById('email-error').textContent = 'Email is required';
            isValid = false;
         } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            document.getElementById('email-error').textContent = 'Please enter a valid email';
            isValid = false;
         }
         
         if (!password) {
            document.getElementById('password-error').textContent = 'Password is required';
            isValid = false;
         } else if (password.length < 6) {
            document.getElementById('password-error').textContent = 'Password must be at least 6 characters';
            isValid = false;
         }
         
         if (password !== confirmPassword) {
            document.getElementById('confirm-password-error').textContent = 'Passwords do not match';
            isValid = false;
         }
         
         if (!walletAddress) {
            document.getElementById('wallet-address-error').textContent = 'Please connect your wallet';
            isValid = false;
         }
         
         if (!signature || !signedMessage) {
            document.getElementById('wallet-address-error').textContent = 'Wallet verification required';
            isValid = false;
         }
         
         if (!agreePolicy) {
            document.getElementById('agree-policy-error').textContent = 'You must agree to the Privacy & Policy';
            isValid = false;
         }
         
         // If form is valid, submit
         if (isValid) {
            // Disable submit button to prevent double submission
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="loading"></div> Creating account...';
            
            try {
               // Submit the form data via fetch API
               const response = await fetch('/api/signup', {
                  method: 'POST',
                  headers: {
                     'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                     first_name: firstName,
                     last_name: lastName,
                     email: email,
                     password: password,
                     wallet_address: walletAddress,
                     signature: signature,
                     signed_message: signedMessage
                  })
               });
               
               const data = await response.json();
               
               if (data.success) {
                  document.getElementById('success-message').textContent = data.message;
                  signupForm.reset();
                  // Reset wallet status
                  walletStatus.className = 'wallet-status not-connected';
                  walletStatus.innerHTML = '<i class="fa-solid fa-circle-xmark"></i> Not connected';
                  
                  // Redirect to login page after a delay
                  setTimeout(() => {
                     window.location.href = '/login';
                  }, 2000);
               } else {
                  document.getElementById('success-message').textContent = data.message || 'An error occurred';
                  document.getElementById('success-message').style.color = 'red';
               }
            } catch (error) {
               console.error('Error:', error);
               document.getElementById('success-message').textContent = 'An error occurred. Please try again later.';
               document.getElementById('success-message').style.color = 'red';
            } finally {
               // Re-enable submit button
               submitBtn.disabled = false;
               submitBtn.innerHTML = 'Create account';
            }
         }
      });
   </script>   
</body>
</html>