<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1, user-scalable=no">
   <title>OpenFund - Funding management</title>
   <link rel="icon" href="/static/app_assets/open_fund_logo.png">
   <link rel="stylesheet" href="/static/css/style.css">
   <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
   <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.0/dist/ethers.umd.min.js"></script>
   <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
   <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>
   <div class="loading-spinner hidden" id="loading-spinner">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><circle fill="#000000" stroke="#000000" stroke-width="15" r="15" cx="40" cy="100"><animate attributeName="opacity" calcMode="spline" dur="2" values="1;0;1;" keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.4"></animate></circle><circle fill="#000000" stroke="#000000" stroke-width="15" r="15" cx="100" cy="100"><animate attributeName="opacity" calcMode="spline" dur="2" values="1;0;1;" keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.2"></animate></circle><circle fill="#000000" stroke="#000000" stroke-width="15" r="15" cx="160" cy="100"><animate attributeName="opacity" calcMode="spline" dur="2" values="1;0;1;" keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="0"></animate></circle></svg>
   </div>
   <div class="overlay hidden" id="overlay"></div>
   <div class="connect-wallet-box hidden" id="connect-wallet-box">
      <button class="close-connect-wallet-btn" id="close-connect-wallet-btn">
         <i class="fa-solid fa-xmark"></i>
      </button>
      <h1>Connect wallet</h1>
      <p>(For investors only)</p>
      <hr style="width: 100px;">
      <button class="wallet_intergrated" data-wallet="metamask"><img class="wallet-icon-logo" src="/static/app_assets/metamask.png" alt="Metamask logo">Metamask</button>
      <button class="wallet_intergrated" data-wallet="binance"><img class="wallet-icon-logo" src="/static/app_assets/binance_web3.png" alt="Metamask logo">Binance Web3</button>
      <button class="wallet_intergrated" data-wallet="okx"><img class="wallet-icon-logo" src="/static/app_assets/okx_web3.png" alt="Metamask logo">OKX Web3</button>
      <button class="wallet_intergrated" data-wallet="trust"><img class="wallet-icon-logo" src="/static/app_assets/trust_wallet.png" alt="Metamask logo">Trust Wallet</button>
      <button class="wallet_intergrated" data-wallet="coinbase"><img class="wallet-icon-logo" src="/static/app_assets/coinbase_wallet.png" alt="Metamask logo">Coinbase Wallet</button>
      <p>By connecting a wallet, you agree to the OpenFundâ€™s <a style="color:black" href="/legal#terms-of-service">Terms of Service</a> and consent to its <a style="color:black" href="/legal#privacy-policy">Privacy Policy</a>.</p>
   </div>
   <style>
      body {
         font-family: 'Poppins', sans-serif;
         margin: 0;
         padding: 0;
      }
      
      .funding-management-container {
         max-width: 600px;
         padding: 20px;
      }
      
      .divide-section {
         width: 100%;
         border: solid 0.5px black;
         background-color: black;
         height: 0.5px;
         opacity: 0.1;
         margin: 10px 0;
      }
      
      .back-button {
         font-size: 18px;
         cursor: pointer;
         margin-right: 15px;
         color: #333;
      }
      
      .project-logo {
         width: 30px;
         height: 30px;
         border-radius: 50%;
         object-fit: cover;
      }
      
      .funding-card {
         background-color: #f0f2f5;
         border-radius: 15px;
         padding: 20px;
         margin-bottom: 20px;
         box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      
      .funding-card h3 {
         margin-top: 0;
         color: #333;
         font-size: 18px;
         display: flex;
         align-items: center;
      }
      
      .funding-card h3 i {
         margin-right: 10px;
      }
      
      .info-grid {
         display: grid;
         grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
         gap: 15px;
         margin-bottom: 20px;
      }
      
      .info-item {
         background-color: #fff;
         padding: 15px;
         border-radius: 10px;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      
      .info-label {
         color: #666;
         font-size: 13px;
         margin: 0;
      }
      
      .info-value {
         margin: 8px 0 0 0;
         font-weight: 600;
         font-size: 16px;
         word-break: break-word;
      }
      
      .wallet-section {
         display: flex;
         align-items: center;
         justify-content: space-between;
         margin-bottom: 20px;
      }
      
      .wallet-address {
         font-size: 14px;
         color: #555;
         word-break: break-word;
         max-width: 70%;
      }
      
      .wallet-balance {
         background-color: #e8f4fd;
         padding: 10px 15px;
         border-radius: 8px;
         font-weight: 500;
         color: #0066cc;
      }
      
      .action-button {
         display: block;
         width: 100%;
         padding: 15px;
         background: linear-gradient(135deg, #000145, #3e3e8e);
         color: white;
         border: none;
         border-radius: 8px;
         font-weight: 600;
         margin-bottom: 10px;
         cursor: pointer;
         transition: all 0.2s ease;
      }
      
      .action-button:disabled {
         background: #c0c0c0;
         cursor: not-allowed;
      }
      
      .action-button:hover:not(:disabled) {
         transform: translateY(-2px);
         box-shadow: 0 5px 10px rgba(0, 1, 69, 0.2);
      }
      
      .status-tag {
         display: inline-block;
         padding: 5px 10px;
         border-radius: 20px;
         font-size: 12px;
         font-weight: 600;
      }
      
      .status-raising, .status-created {
         background-color: #e3f2fd;
         color: #0066cc;
      }
      
      .status-voting {
         background-color: #fff8e1;
         color: #ff8f00;
      }
      
      .status-completed {
         background-color: #e8f5e9;
         color: #2e7d32;
      }
      
      .status-failed {
         background-color: #ffebee;
         color: #c62828;
      }

      .connect-button {
         display: block;
         width: 100%;
         padding: 15px;
         background: linear-gradient(135deg, #000145, #3e3e8e);
         color: white;
         border: none;
         border-radius: 8px;
         font-weight: 600;
         margin-bottom: 10px;
         cursor: pointer;
      }
      #disconnect-wallet-btn{
         background: white;
         color: black;
         border: solid 1px rgb(90, 90, 90);
      }
      #disconnect-wallet-btn:hover {
         background: #e23a3a;
         color: white
      }
      .eligibility-check {
         font-size: 14px;
         margin: 10px 0;
         padding: 10px;
         border-radius: 5px;
         text-align: center;
      }

      .eligible {
         background-color: #e8f5e9;
         color: #2e7d32;
      }

      .not-eligible {
         background-color: #ffebee;
         color: #c62828;
      }

      .timeline {
         margin: 30px 0;
         position: relative;
      }

      .timeline:before {
         content: "";
         position: absolute;
         top: 0;
         left: 15px;
         width: 2px;
         height: 100%;
         background-color: #e0e0e0;
      }

      .timeline-item {
         position: relative;
         padding-left: 40px;
         margin-bottom: 20px;
      }

      .timeline-dot {
         position: absolute;
         left: 9px;
         top: 5px;
         width: 14px;
         height: 14px;
         border-radius: 50%;
         background-color: #000145;
      }

      .timeline-date {
         color: #666;
         font-size: 12px;
         margin-bottom: 5px;
      }

      .timeline-content {
         background-color: #f9f9f9;
         border-radius: 8px;
         padding: 15px;
      }

      .timeline-title {
         margin: 0 0 10px 0;
         font-size: 16px;
         color: #333;
      }

      .progress-container {
         margin: 20px 0;
      }

      .progress-label {
         display: flex;
         justify-content: space-between;
         margin-bottom: 5px;
         font-size: 14px;
      }

      .progress-bar {
         height: 8px;
         background-color: #e9ecef;
         border-radius: 4px;
         overflow: hidden;
         margin-bottom: 5px;
      }

      .progress {
         height: 100%;
         background: linear-gradient(135deg, #000145, #3e3e8e);
         border-radius: 4px;
      }

      .token-info {
         font-size: 12px;
         color: #6c757d;
         display: flex;
         justify-content: space-between;
      }

      .warning-text {
         color: #c62828;
         font-size: 13px;
         margin: 10px 0;
      }

      @media (max-width: 768px) {
         .info-grid {
            grid-template-columns: 1fr;
         }

         .wallet-section {
            flex-direction: column;
            align-items: flex-start;
         }

         .wallet-address {
            max-width: 100%;
            margin-bottom: 10px;
         }
      }
   </style>

   <div class="funding-management-container">
      <div style="display: flex; align-items: center; gap: 10px">
      <div class="back-button" onclick="window.history.back()">
         <i class="fa-solid fa-arrow-left"></i>
      </div>
      <h2 style="font-size: 1rem; margin: 0">Funding Management</h2>
      <img src="{{ project_data.logo_url }}" alt="{{ project_data.name }}" class="project-logo">
      <span class="status-tag status-{{ project_data.funding_status }}">
         {{ project_data.funding_status.capitalize() }}
      </span>
      </div>
      <div class="divide-section"></div>

      <!-- Project Stats -->
      <div class="funding-card" style="margin-top: 20px;">
         <h3>
            <i class="fa-solid fa-chart-line"></i>
            Project Stats
         </h3>
         <div class="info-grid">
            <div class="info-item">
               <p class="info-label">Token Name</p>
               <p class="info-value">{{ project_data.token_name }} ({{ project_data.token_symbol }})</p>
            </div>
            <div class="info-item">
               <p class="info-label">Token Address</p>
               <p class="info-value" style="font-size: 16px;">{{ project_data.token_address }}</p>
            </div>
            <div class="info-item">
               <p class="info-label">Token Decimals</p>
               <p class="info-value">{{ project_data.decimal }}</p>
            </div>
            <div class="info-item">
               <p class="info-label">Tokens to Sell</p>
               <p class="info-value">{{ "{:,}".format(project_data.token_to_sell) }} {{ project_data.token_symbol }}</p>
            </div>
            <div class="info-item">
               <p class="info-label">Tokens Sold</p>
               <p class="info-value">{{ "{:,}".format(project_data.token_sold) }} {{ project_data.token_symbol }}</p>
            </div>
            <div class="info-item">
               <p class="info-label">Funds Raised</p>
               <p class="info-value">{{ "{:,}".format(project_data.fund_raised) }} USDT</p>
            </div>
         </div>

         <div class="progress-container">
            <div class="progress-label">
               <span>Token Sale Progress</span>
               <span id="token-sale-progress">0%</span>
            </div>
            <div class="progress-bar">
               <div class="progress" id="progress-bar"></div>
            </div>
            <div class="token-info">
               <span id="token-sold">{{ "{:,}".format(project_data.token_sold) }} {{ project_data.token_symbol }}</span>
               <span id="token-to-sell">{{ "{:,}".format(project_data.token_to_sell) }} {{ project_data.token_symbol }}</span>
            </div>
         </div>
      </div>

      <!-- Wallet Connection -->
      <div class="funding-card">
         <h3>
            <i class="fa-solid fa-wallet"></i>
            Wallet Connection
         </h3>
         
         <div id="wallet-connect-section">
            <p>Please connect your wallet to manage this project. You must use the same wallet address registered as the project's funding address.</p>
            <p class="info-label">Funding Address: <span class="info-value" style="font-size: 13px;">{{ project_data.funding_address }}</span></p>
            <button id="connect-wallet-btn" class="connect-button">Connect Wallet</button>
         </div>
         
         <div id="wallet-connected-section" class="hidden">
            <div class="wallet-section">
               <div class="wallet-address">
                  Connected: <span id="connected-address"></span>
               </div>
               <div class="wallet-balance" id="token-balance">
                  Loading balance...
               </div>
            </div>
            
            <div id="eligibility-check" class="eligibility-check not-eligible">
               Checking wallet eligibility...
            </div>

            <button id="disconnect-wallet-btn" class="connect-button">Disonnect Wallet</button>
         </div>
      </div>

      <!-- Project Timeline -->
      <div class="funding-card">
         <h3>
            <i class="fa-solid fa-clock-rotate-left"></i>
            Project Timeline
         </h3>
         
         <div class="timeline">
            <div class="timeline-item">
               <div class="timeline-dot"></div>
               <div class="timeline-date">Project Creation</div>
               <div class="timeline-content">
                  <h4 class="timeline-title">Project Created</h4>
                  <p>Project listed on OpenFund</p>
               </div>
            </div>
            
            <div class="timeline-item" id="timeline-deposit">
               <div class="timeline-dot"></div>
               <div class="timeline-date" id="deposit-date">Deposit Tokens</div>
               <div class="timeline-content">
                  <h4 class="timeline-title">Token Deposit</h4>
                  <p>Raiser must deposit {{ "{:,}".format(project_data.token_to_sell) }} {{ project_data.token_symbol }} to start funding</p>
               </div>
            </div>
            
            <div class="timeline-item" id="timeline-funding">
               <div class="timeline-dot"></div>
               <div class="timeline-date" id="funding-end-date">{{ project_data.investment_end_time }}</div>
               <div class="timeline-content">
                  <h4 class="timeline-title">Funding Period Ends</h4>
                  <p>Project enters voting period</p>
               </div>
            </div>
            
            <div class="timeline-item" id="timeline-voting">
               <div class="timeline-dot"></div>
               <div class="timeline-date" id="voting-end-date">Voting period</div>
               <div class="timeline-content">
                  <h4 class="timeline-title">Voting Period Ends</h4>
                  <p>Investors can vote for refund or approve funding</p>
               </div>
            </div>
            
            <div class="timeline-item" id="timeline-refund">
               <div class="timeline-dot"></div>
               <div class="timeline-date" id="refund-end-date">Refund period</div>
               <div class="timeline-content">
                  <h4 class="timeline-title">Refund Period Ends</h4>
                  <p>Investors can claim refunds if project failed</p>
               </div>
            </div>
            
            <div class="timeline-item" id="timeline-completion">
               <div class="timeline-dot"></div>
               <div class="timeline-date">Project Completion</div>
               <div class="timeline-content">
                  <h4 class="timeline-title">Project Completion</h4>
                  <p>Raiser can claim funds and unsold tokens</p>
               </div>
            </div>
         </div>
      </div>

      <!-- Action Buttons -->
      <div class="funding-card">
         <h3>
            <i class="fa-solid fa-gear"></i>
            Actions
         </h3>
         
         <button id="deposit-tokens-btn" class="action-button" disabled>
            Deposit Tokens to Start Funding
         </button>
         
         <button id="claim-funds-btn" class="action-button" disabled>
            Claim Raised Funds
         </button>
         
         <button id="claim-unsold-tokens-btn" class="action-button" disabled>
            Claim Unsold Tokens
         </button>
         
         <p class="warning-text" id="action-warning"></p>
      </div>
   </div>

   <script src="/static/script/main.js"></script>
   <script>
      // Contract configurations
      const contractConfig = {
         openFundAddress: "0x392cd2aeb4a903c74e718b1ed96add7f02881bf6",
         projectId: {{ project_data.id }},
         tokenContractAddress: "{{ project_data.token_address }}",
         fundingAddress: "{{ project_data.funding_address }}",
         tokenDecimals: {{ project_data.decimal }},
         rpcUrl: "https://evm-rpc-arctic-1.sei-apis.com"
      };

      // ABIs
      const openFundABI = [
         "function depositTokens(uint256 _projectId) external",
         "function claimFunds(uint256 _projectId) external",
         "function claimUnsoldTokens(uint256 _projectId) external",
         "function getProjectDetails(uint256 _projectId) external view returns (address, address, uint256, uint256, uint256, uint256, uint256, uint8, bool, uint256, bool)"
      ];

      const erc20ABI = [
         "function balanceOf(address owner) view returns (uint256)",
         "function decimals() view returns (uint8)",
         "function approve(address spender, uint256 amount) external returns (bool)",
         "function allowance(address owner, address spender) view returns (uint256)"
      ];

      // Global variables
      let provider, signer, tokenContract, openFundContract;
      let connectedAddress = null;
      let projectDetails = null;
      
      // DOM elements
      const loadingSpinner = document.getElementById('loading-spinner');
      const overlay = document.getElementById('overlay');
      const connectWalletBtn = document.getElementById('connect-wallet-btn');
      const disconnectWalletBtn = document.getElementById('disconnect-wallet-btn');
      const walletConnectSection = document.getElementById('wallet-connect-section');
      const walletConnectedSection = document.getElementById('wallet-connected-section');
      const connectedAddressEl = document.getElementById('connected-address');
      const tokenBalanceEl = document.getElementById('token-balance');
      const eligibilityCheckEl = document.getElementById('eligibility-check');
      const depositTokensBtn = document.getElementById('deposit-tokens-btn');
      const claimFundsBtn = document.getElementById('claim-funds-btn');
      const claimUnsoldTokensBtn = document.getElementById('claim-unsold-tokens-btn');
      const actionWarning = document.getElementById('action-warning');
      const progressBar = document.getElementById('progress-bar');
      const tokenSaleProgress = document.getElementById('token-sale-progress');
      const close_wallet_btn = document.getElementById("close-connect-wallet-btn");
      const connect_box = document.getElementById("connect-wallet-box");

      const isMetaMaskInstalled = () => {
         return Boolean(window.ethereum && window.ethereum.isMetaMask);
      };

      const isBinanceWalletInstalled = () => {
         return Boolean(window.ethereum);
      };

      const isOKXWalletInstalled = () => {
         return Boolean(window.okxwallet);
      };

      const isTrustWalletInstalled = () => {
         return Boolean(window.trustwallet || (window.ethereum && window.ethereum.isTrust));
      };

      const isCoinbaseWalletInstalled = () => {
         return Boolean(window.ethereum && window.ethereum.isCoinbaseWallet);
      };

      // Initialize the page
      document.addEventListener('DOMContentLoaded', function() {
         updateProgressBar();
         setUpTimeline();
         
         // Check if wallet is already connected
         const storedWallet = localStorage.getItem('selectedWallet');
         if (storedWallet) {
            initializeWalletConnection(storedWallet);
         }
      });

      // Connect wallet button event
      connectWalletBtn.addEventListener('click', async function() {
         connect_box.classList.remove("hidden");
         overlay.classList.remove("hidden");
      });

      close_wallet_btn.addEventListener("click", function() {
         connect_box.classList.add("hidden");
         overlay.classList.add("hidden");
      });

      disconnectWalletBtn.addEventListener('click', async function() {
         try {
            await window.ethereum.request({
               method: 'wallet_revokePermissions',
               params: [
                  {
                     eth_accounts: {},
                  },
               ],
            });
            await window.ethereum.request({
               method: 'wallet_disconnect',
               params: [
                  {
                     eth_accounts: {},
                  },
               ],
            });
         } catch (error) {
            console.error('Failed to disconnect wallet:', error);
         }
         location.reload();
      });
      async function initializeWalletConnection(walletType) {
         try {
            loadingSpinner.classList.remove('hidden');
            overlay.classList.remove('hidden');
            if (localStorage.getItem('selectedWallet')) {
               const storedWallet = localStorage.getItem('selectedWallet');
               
               switch (storedWallet) {
               case 'metamask':
               case 'binance':
               case 'coinbase':
                  if (window.ethereum) {
                     provider = window.ethereum;
                     const accounts = await provider.request({ method: 'eth_accounts' });
                     isConnected = accounts && accounts.length > 0;
                  }
                  break;
               case 'okx':
                  if (window.okxwallet) {
                     provider = window.okxwallet;
                     const accounts = await provider.request({ method: 'eth_accounts' });
                     isConnected = accounts && accounts.length > 0;
                  }
                  break;
               case 'trust':
                  provider = window.trustwallet || (window.ethereum && window.ethereum.isTrust ? window.ethereum : null);
                  if (provider) {
                     const accounts = await provider.request({ method: 'eth_requestAccounts' });
                     isConnected = accounts && accounts.length > 0;
                  }
                  break;
               }
            }
            if (!isConnected) {
               if (walletType === 'okx'){
                  await window.ethereum.request({
                     method: 'wallet_disconnect',
                     params: [
                        {
                           eth_accounts: {},
                        },
                     ],
                  });
                  } else {
                     await window.ethereum.request({
                        method: 'wallet_revokePermissions',
                        params: [
                           {
                              eth_accounts: {},
                           },
                        ],
                     });
                  }
               localStorage.removeItem('selectedWallet');
               loadingSpinner.classList.add('hidden');
               overlay.classList.add('hidden');
            } else {
               await connectWithWallet(walletType);
               loadingSpinner.classList.add('hidden');
               overlay.classList.add('hidden');
            }
         } catch (error) {
            console.error('Failed to initialize wallet connection:', error);
            loadingSpinner.classList.add('hidden');
            overlay.classList.add('hidden');
         }
      }

      document.querySelectorAll('.wallet_intergrated').forEach(button => {
         button.addEventListener('click', async function() {
            const walletType = this.getAttribute('data-wallet');
            selectedWallet = walletType;
            localStorage.setItem('selectedWallet', walletType);
            loadingSpinner.classList.remove("hidden");
            
            try {
               await connectWithWallet(walletType);
            } catch (error) {
               console.error(`Error with ${walletType}:`, error);
               walletAddressInput.value = '';
            } finally {
               loadingSpinner.classList.add("hidden");
               connect_box.classList.add("hidden");
               overlay.classList.add("hidden");
            }
         });
      });
      // Connect with selected wallet
      async function connectWithWallet(walletType) {
         try {
            let windowProvider;
            
            switch (walletType) {
               case 'metamask':
               case 'binance':
               case 'coinbase':
                  if (!window.ethereum) {
                     throw new Error(`${walletType} wallet not detected`);
                  }
                  windowProvider = window.ethereum;
                  break;
                  
               case 'okx':
                  if (!window.okxwallet) {
                     throw new Error('OKX wallet not detected');
                  }
                  windowProvider = window.okxwallet;
                  break;
                  
               case 'trust':
                  windowProvider = window.trustwallet || (window.ethereum && window.ethereum.isTrust ? window.ethereum : null);
                  if (!windowProvider) {
                     throw new Error('Trust wallet not detected');
                  }
                  break;
                  
               default:
                  throw new Error('Unsupported wallet type');
            }
            
            // Switch to the correct network
            await switchToNetwork(windowProvider);
            
            // Initialize provider and get signer
            provider = new ethers.BrowserProvider(windowProvider);
            signer = await provider.getSigner();
            connectedAddress = await signer.getAddress();
            
            // Initialize contracts
            openFundContract = new ethers.Contract(contractConfig.openFundAddress, openFundABI, signer);
            tokenContract = new ethers.Contract(contractConfig.tokenContractAddress, erc20ABI, signer);
            
            // Save selected wallet
            localStorage.setItem('selectedWallet', walletType);
            
            // Update UI
            connectedAddressEl.textContent = `${connectedAddress.substring(0, 8)}...${connectedAddress.substring(connectedAddress.length - 6)}`;
            walletConnectSection.classList.add('hidden');
            walletConnectedSection.classList.remove('hidden');
            
            // Check if connected address matches funding address
            checkEligibility();
            
            // Update token balance
            await updateTokenBalance();
            
            // Fetch project details
            await fetchProjectDetails();
            
            // Update UI based on project status
            updateActionsBasedOnStatus();
            
            showToastMessage('Wallet connected successfully!', true);
         } catch (error) {
            console.error('Wallet connection failed:', error);
            showToastMessage(`Failed to connect wallet: ${error.message}`, false);
            throw error;
         }
      }

      // Switch to the correct network
      async function switchToNetwork(provider) {
         try {
            await provider.request({
               method: 'wallet_switchEthereumChain',
               params: [{ chainId: '0xae3f3' }], // SEI DEVNET chainId
            });
         } catch (switchError) {
            // Chain doesn't exist, add it
            if (switchError.code === 4902) {
               try {
                  await provider.request({
                     method: 'wallet_addEthereumChain',
                     params: [{
                        chainId: '0xae3f3',
                        chainName: 'SEI DEVNET',
                        nativeCurrency: {
                           name: 'SEI',
                           symbol: 'SEI',
                           decimals: 18
                        },
                        rpcUrls: ['https://evm-rpc-arctic-1.sei-apis.com'],
                        blockExplorerUrls: ['https://seitrace.com/?chain=arctic-1']
                     }],
                  });
                  
                  // Try switching again
                  await provider.request({
                     method: 'wallet_switchEthereumChain',
                     params: [{ chainId: '0xae3f3' }],
                  });
               } catch (addError) {
                  console.error('Failed to add network:', addError);
                  throw new Error('Could not add the SEI DEVNET network to your wallet');
               }
            } else {
               console.error('Failed to switch network:', switchError);
               throw new Error('Could not switch to the SEI DEVNET network');
            }
         }
      }

      // Check if connected address matches funding address
      function checkEligibility() {
         const isEligible = connectedAddress.toLowerCase() === contractConfig.fundingAddress.toLowerCase();
         
         if (isEligible) {
            eligibilityCheckEl.textContent = 'Your wallet address matches the funding address. You can manage this project.';
            eligibilityCheckEl.classList.remove('not-eligible');
            eligibilityCheckEl.classList.add('eligible');
         } else {
            eligibilityCheckEl.textContent = 'Your wallet address does not match the project\'s funding address. You cannot manage this project.';
            eligibilityCheckEl.classList.remove('eligible');
            eligibilityCheckEl.classList.add('not-eligible');
         }
         
         return isEligible;
      }

      // Update token balance
      async function updateTokenBalance() {
         if (!connectedAddress || !tokenContract) return;
         
         try {
            const balance = await tokenContract.balanceOf(connectedAddress);
            const formattedBalance = ethers.formatUnits(balance, contractConfig.tokenDecimals);
            tokenBalanceEl.textContent = `${parseFloat(formattedBalance).toLocaleString()} ${projectDetails ? 
               projectDetails.tokenSymbol : '{{ project_data.token_symbol }}'}`;
         } catch (error) {
            console.error('Failed to update token balance:', error);
            tokenBalanceEl.textContent = 'Failed to load balance';
         }
      }

      // Fetch project details from smart contract
      async function fetchProjectDetails() {
         try {
            const details = await openFundContract.getProjectDetails(contractConfig.projectId);
            projectDetails = {
               raiser: details[0],
               tokenAddress: details[1],
               tokensToSell: Number(details[2]),
               tokensSold: Number(details[3]),
               tokenPrice: Number(details[4]),
               endFundingTime: Number(details[5]),
               fundsRaised: Number(details[6]),
               status: Number(details[7]),
               unsoldTokensClaimed: details[8],
               voteForRefundAmount: Number(details[9]),
               fundsClaimed: details[10],
               tokenSymbol: '{{ project_data.token_symbol }}'
            };
            
            updateUIWithProjectDetails();
         } catch (error) {
            console.error('Failed to fetch project details:', error);
            showToastMessage('Failed to fetch project details from blockchain', false);
         }
      }

      // Update UI with project details
      function updateUIWithProjectDetails() {
         if (!projectDetails) return;
         
         // Update progress bar
         updateProgressBar();
         
         // Update action warnings based on status
         updateActionsBasedOnStatus();
      }

      // Update progress bar
      function updateProgressBar() {
         let tokenSold, tokenToSell;
         
         if (projectDetails) {
            tokenSold = projectDetails.tokensSold;
            tokenToSell = projectDetails.tokensToSell;
         } else {
            tokenSold = {{ project_data.token_sold }};
            tokenToSell = {{ project_data.token_to_sell }};
         }
         
         const percentage = tokenToSell > 0 ? (tokenSold / tokenToSell) * 100 : 0;
         progressBar.style.width = `${percentage}%`;
         tokenSaleProgress.textContent = `${percentage.toFixed(2)}%`;
      }

      // Set up timeline dates
      function setUpTimeline() {
         const endFundingTime = {{ project_data.investment_end_time }};
         const endVotingTime = endFundingTime + (3 * 24 * 60 * 60); // 3 days after funding
         const endRefundTime = endFundingTime + (4 * 24 * 60 * 60); // 4 days after funding
         
         document.getElementById('funding-end-date').textContent = formatTimestamp(endFundingTime);
         document.getElementById('voting-end-date').textContent = formatTimestamp(endVotingTime);
         document.getElementById('refund-end-date').textContent = formatTimestamp(endRefundTime);
      }

      // Format timestamp
      function formatTimestamp(timestamp) {
         return new Date(timestamp * 1000).toLocaleDateString('en-US', {
            year: 'numeric', 
            month: 'short', 
            day: 'numeric'
         });
      }

      // Update actions based on project status
      function updateActionsBasedOnStatus() {
         if (!projectDetails || !connectedAddress) return;
         
         const isEligible = connectedAddress.toLowerCase() === contractConfig.fundingAddress.toLowerCase();
         if (!isEligible) {
            depositTokensBtn.disabled = true;
            claimFundsBtn.disabled = true;
            claimUnsoldTokensBtn.disabled = true;
            actionWarning.textContent = "You are not authorized to manage this project.";
            return;
         }
         
         const currentTime = Math.floor(Date.now() / 1000);
         const endFundingTime = projectDetails.endFundingTime;
         const endRefundTime = endFundingTime + (4 * 24 * 60 * 60); // 4 days after funding ends
         
         // Status: 0 = InitialCreated, 1 = RaisingPeriod, 2 = VotingPeriod, 3 = FundingFailed, 4 = FundingCompleted
         switch (projectDetails.status) {
            case 0: // InitialCreated
               depositTokensBtn.disabled = false;
               claimFundsBtn.disabled = true;
               claimUnsoldTokensBtn.disabled = true;
               actionWarning.textContent = "You need to deposit tokens to start the funding period.";
               break;
               
            case 1: // RaisingPeriod
               depositTokensBtn.disabled = true;
               claimFundsBtn.disabled = true;
               claimUnsoldTokensBtn.disabled = true;
               actionWarning.textContent = "The project is in the raising period. You can claim funds after it ends and is approved.";
               break;
               
            case 2: // VotingPeriod
               depositTokensBtn.disabled = true;
               claimFundsBtn.disabled = true;
               claimUnsoldTokensBtn.disabled = true;
               actionWarning.textContent = "The project is in the voting period. Investors are voting on whether to refund or approve.";
               if (currentTime > endRefundTime){
                  claimFundsBtn.disabled = false;
                  claimUnsoldTokensBtn.disabled = false;
                  actionWarning.textContent = "You can claim funds and unsold tokens now.";
               }
               break;
               
            case 3,4: // FundingFailed
               depositTokensBtn.disabled = true;
               //claimFundsBtn.disabled = true;
               
               if (currentTime > endRefundTime && !projectDetails.fundsClaimed && !projectDetails.unsoldTokensClaimed) {
                  claimFundsBtn.disabled = false;
                  claimUnsoldTokensBtn.disabled = false;
                  actionWarning.textContent = "Funding failed. You can claim funds and unsold tokens now.";
               } else if (currentTime <= endRefundTime){
                  claimFundsBtn.disabled = true;
                  claimUnsoldTokensBtn.disabled = true;
                  actionWarning.textContent = `Funding failed. You can claim funds and unsold tokens after ${formatTimestamp(endRefundTime)}.`;
               } else if (currentTime > endRefundTime && projectDetails.fundsClaimed && projectDetails.unsoldTokensClaimed) {
                  claimFundsBtn.disabled = true;
                  claimUnsoldTokensBtn.disabled = true;
                  actionWarning.textContent = "You have already claimed funds and unsold tokens.";
               } else {
                  claimFundsBtn.disabled = true;
                  claimUnsoldTokensBtn.disabled = true;
                  if (!projectDetails.fundsClaimed) {
                     claimFundsBtn.disabled = false;
                  }
                  if (!projectDetails.unsoldTokensClaimed) {
                     claimUnsoldTokensBtn.disabled = false;
                  }
               }
               break;
         }
      }

      // Deposit tokens function
      depositTokensBtn.addEventListener('click', async function() {
         if (!connectedAddress || !tokenContract || !openFundContract) {
            showToastMessage('Please connect your wallet first', false);
            return;
         }
         
         try {
            loadingSpinner.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            const tokensToSell = {{ project_data.token_to_sell }};
            const tokenDecimals = {{ project_data.decimal }};
            const tokensToSellWithDecimals = BigInt(tokensToSell) * BigInt(10) ** BigInt(tokenDecimals);
            
            // Check balance
            const balance = await tokenContract.balanceOf(connectedAddress);
            if (balance < tokensToSellWithDecimals) {
               showToastMessage(`You don't have enough tokens. You need ${tokensToSell} ${projectDetails.tokenSymbol}`, false);
               loadingSpinner.classList.add('hidden');
               overlay.classList.add('hidden');
               return;
            }
            
            // Check and set approval
            const allowance = await tokenContract.allowance(connectedAddress, contractConfig.openFundAddress);
            if (allowance < tokensToSellWithDecimals) {
               showToastMessage('Approving tokens...', true);
               const approveTx = await tokenContract.approve(contractConfig.openFundAddress, tokensToSellWithDecimals);
               await approveTx.wait();
               showToastMessage('Tokens approved', true);
            }
            
            // Deposit tokens
            showToastMessage('Depositing tokens...', true);
            const depositTx = await openFundContract.depositTokens(contractConfig.projectId);
            
            showToastMessage('Transaction submitted, waiting for confirmation...', true);
            await depositTx.wait();
            
            showToastMessage('Tokens deposited successfully!', true);
            
            // Refresh data
            await fetchProjectDetails();
            await updateTokenBalance();
            updateActionsBasedOnStatus();
            setTimeout(() => {
					location.reload();
				}, 2000);
         } catch (error) {
            console.error('Failed to deposit tokens:', error);
            showToastMessage(`Failed to deposit tokens: ${error.reason || error.message}`, false);
            setTimeout(() => {
					location.reload();
				}, 2000);
         } finally {
            loadingSpinner.classList.add('hidden');
            overlay.classList.add('hidden');
         }
      });

      // Claim funds function
      claimFundsBtn.addEventListener('click', async function() {
         if (!connectedAddress || !openFundContract) {
            showToastMessage('Please connect your wallet first', false);
            return;
         }
         
         try {
            loadingSpinner.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            showToastMessage('Claiming funds...', true);
            const claimTx = await openFundContract.claimFunds(contractConfig.projectId);
            
            showToastMessage('Transaction submitted, waiting for confirmation...', true);
            await claimTx.wait();
            
            showToastMessage('Funds claimed successfully!', true);
            
            // Refresh data
            await fetchProjectDetails();
            updateActionsBasedOnStatus();
            setTimeout(() => {
					location.reload();
				}, 2000);
         } catch (error) {
            console.error('Failed to claim funds:', error);
            showToastMessage(`Failed to claim funds: ${error.reason || error.message}`, false);
            setTimeout(() => {
					location.reload();
				}, 2000);
         } finally {
            loadingSpinner.classList.add('hidden');
            overlay.classList.add('hidden');
         }
      });

      // Claim unsold tokens function
      claimUnsoldTokensBtn.addEventListener('click', async function() {
         if (!connectedAddress || !openFundContract) {
            showToastMessage('Please connect your wallet first', false);
            return;
         }
         
         try {
            loadingSpinner.classList.remove('hidden');
            overlay.classList.remove('hidden');
            
            showToastMessage('Claiming unsold tokens...', true);
            const claimTx = await openFundContract.claimUnsoldTokens(contractConfig.projectId);
            
            showToastMessage('Transaction submitted, waiting for confirmation...', true);
            await claimTx.wait();
            
            showToastMessage('Unsold tokens claimed successfully!', true);
            
            // Refresh data
            await fetchProjectDetails();
            await updateTokenBalance();
            updateActionsBasedOnStatus();
            setTimeout(() => {
					location.reload();
				}, 2000);
         } catch (error) {
            console.error('Failed to claim unsold tokens:', error);
            showToastMessage(`Failed to claim unsold tokens: ${error.reason || error.message}`, false);
            setTimeout(() => {
					location.reload();
				}, 2000);
         } finally {
            loadingSpinner.classList.add('hidden');
            overlay.classList.add('hidden');
         }
      });
   </script>
</body>
</html>